From caecf263457438149655b3989b064ea9d221c6ee Mon Sep 17 00:00:00 2001
From: Pontus Fuchs <pontus.fuchs@gmail.com>
Date: Mon, 10 Sep 2012 16:29:48 +0200
Subject: [PATCH 28/82] Allocate RX skb's using alloc_skb()

While moving RX skb allocation to wq context I forgot
to convert to alloc_skb.
---
 ar5523.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/net/wireless/ath/ar5523/ar5523.c
+++ b/drivers/net/wireless/ath/ar5523/ar5523.c
@@ -810,7 +810,7 @@ static void ar5523_rx_refill_work(struct
 	while (!list_empty(&ar->rx_data_free)) {
 		data = (struct ar5523_rx_data *) ar->rx_data_free.next;
 
-		data->skb = dev_alloc_skb(ar->rxbufsz);
+		data->skb = alloc_skb(ar->rxbufsz, GFP_KERNEL);
 		if (!data->skb) {
 			ar5523_err(ar, "could not allocate rx skbuff\n");
 			return;
@@ -823,6 +823,7 @@ static void ar5523_rx_refill_work(struct
 
 		error = usb_submit_urb(data->urb, GFP_KERNEL);
 		if (error) {
+			kfree_skb(data->skb);
 			ar5523_err(ar, "error %d when submitting rx data urb\n",
 				       error);
 			return;

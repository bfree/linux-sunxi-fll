From dcb0d6af79e3113b9573b019f99f41bdec937637 Mon Sep 17 00:00:00 2001
From: Pontus Fuchs <pontus.fuchs@gmail.com>
Date: Mon, 24 Sep 2012 16:20:33 +0200
Subject: [PATCH 45/82] Remove AR5523_TX_QUEUE_STOPPED

Not needed and racy.
---
 ar5523.c |   27 ++++++++++++---------------
 1 file changed, 12 insertions(+), 15 deletions(-)

--- a/drivers/net/wireless/ath/ar5523/ar5523.c
+++ b/drivers/net/wireless/ath/ar5523/ar5523.c
@@ -102,7 +102,6 @@ enum {
 
 enum AR5523_flags {
 	AR5523_HW_UP,
-	AR5523_TX_QUEUE_STOPPED,
 	AR5523_CONNECTED
 };
 
@@ -215,7 +214,7 @@ static void ar5523_read_reply(struct ar5
 
 	ar5523_dbg(ar, "Code = %d len = %d\n", hdr->code & 0xff, dlen);
 
-	rp = (u32 *)(hdr+1);
+	rp = (u32 *)(hdr + 1);
 	if (dlen >= sizeof(u32)) {
 		olen = be32_to_cpu(rp[0]);
 		dlen -= sizeof(u32);
@@ -305,7 +304,7 @@ static void ar5523_cmd_rx_cb(struct urb
 			ar5523_err(ar, "Invalid reply to WDCMSG_TARGET_START");
 			return;
 		}
-		memcpy(cmd->odata, hdr+1, sizeof(u32));
+		memcpy(cmd->odata, hdr + 1, sizeof(u32));
 		cmd->olen = sizeof(u32);
 		cmd->res = 0;
 		complete(&cmd->done);
@@ -680,6 +679,7 @@ static void ar5523_data_rx_cb(struct urb
 	int hdrlen, pad;
 	unsigned long flags;
 
+	ar5523_dbg(ar, "%s\n", __func__);
 	/* sync/async unlink faults aren't errors */
 	if (urb->status && (urb->status != -ENOENT &&
 	    urb->status != -ECONNRESET && urb->status != -ESHUTDOWN)) {
@@ -858,11 +858,8 @@ static void ar5523_data_tx_pkt_put(struc
 		wake_up(&ar->tx_flush_waitq);
 
 	if (atomic_read(&ar->tx_nr_total) < AR5523_TX_DATA_RESTART_COUNT) {
-		if (test_and_clear_bit(AR5523_TX_QUEUE_STOPPED, &ar->flags) &&
-		    test_bit(AR5523_HW_UP, &ar->flags)) {
-			ar5523_dbg(ar, "restart tx queue\n");
-			ieee80211_wake_queues(ar->hw);
-		}
+		ar5523_dbg(ar, "restart tx queue\n");
+		ieee80211_wake_queues(ar->hw);
 	}
 }
 
@@ -909,12 +906,10 @@ static void ar5523_tx(struct ieee80211_h
 
 	if (atomic_inc_return(&ar->tx_nr_total) >= AR5523_TX_DATA_COUNT) {
 		ar5523_dbg(ar, "tx queue full\n");
-		if (!test_and_set_bit(AR5523_TX_QUEUE_STOPPED, &ar->flags)) {
-			ar5523_dbg(ar, "stop queues (tot %d pend %d)\n",
-				   atomic_read(&ar->tx_nr_total),
-				   atomic_read(&ar->tx_nr_pending));
-			ieee80211_stop_queues(hw);
-		}
+		ar5523_dbg(ar, "stop queues (tot %d pend %d)\n",
+			   atomic_read(&ar->tx_nr_total),
+			   atomic_read(&ar->tx_nr_pending));
+		ieee80211_stop_queues(hw);
 	}
 
 	data->skb = skb;
@@ -1027,7 +1022,7 @@ static void ar5523_flush_tx(struct ar552
 
 	if (!wait_event_timeout(ar->tx_flush_waitq,
 	    !atomic_read(&ar->tx_nr_pending), HZ * 3))
-		ar5523_dbg(ar, "flush timeout (tot %d pend %d)\n",
+		ar5523_err(ar, "flush timeout (tot %d pend %d)\n",
 			   atomic_read(&ar->tx_nr_total),
 			   atomic_read(&ar->tx_nr_pending));
 }
@@ -1402,6 +1397,8 @@ static void ar5523_configure_filter(stru
 	ar5523_dbg(ar, "configure_filter called\n");
 	mutex_lock(&ar->mutex);
 
+	ar5523_flush_tx(ar);
+
 	*total_flags &= AR5523_SUPPORTED_FILTERS;
 
 	if (*total_flags & FIF_PROMISC_IN_BSS ||
